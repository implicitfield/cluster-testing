name: distcc runner
on:
  workflow_call:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
  PRIMARY_PUBLIC_KEY: ${{ secrets.PRIMARY_PUBLIC_KEY }}
  INSTANCE_0_PRIVATE_KEY: ${{ secrets.INSTANCE_0_PRIVATE_KEY }}
  INSTANCE_1_PRIVATE_KEY: ${{ secrets.INSTANCE_1_PRIVATE_KEY }}
  FULL_REPOSITORY_NAME: ${{ github.repository }}
  RUN_ID: ${{ github.run_id }}

jobs:
  build:
    name: Join the cluster
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        name: Clone repository
      - name: Choose a local port to use
        run: echo "export LOCAL_PORT=$(( 20000 + $RANDOM % 10000 ))" > local_port.sh
      - name: Install dependencies
        run: ./install_auxiliary_dependencies.sh
      - name: Preprocess the auxiliary service initialization script
        run: ./assemble_auxiliary_support.sh ${{ strategy.job-index }} ${{ strategy.job-total }}
      - name: Initialize services
        run: ./generated/start_auxiliary_services.sh ${{ strategy.job-index }}
      - name: Advertise public IP address
        uses: actions/upload-artifact@v4
        with:
          name: Auxiliary${{ strategy.job-index }}IP
          path: Auxiliary${{ strategy.job-index }}IP.txt
      - name: Connect to the primary runner
        run: ./connect.sh ${{ strategy.job-total }}
      - name: Wait for release
        run: ./stall.sh
